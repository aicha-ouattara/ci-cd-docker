name: CI/CD Pipeline - Docker + Tests + Notifications

on:
  push:
    branches: [main]
  create:
    tags: ['v*']

jobs:
  build-test-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ R√©cup√©ration du code
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Ex√©cution des tests
      - name: Run tests
        run: |
          cd app
          chmod +x check_app.sh
          ./check_app.sh

      # 3Ô∏è‚É£ Connexion au registre Docker
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # 4Ô∏è‚É£ Construction de l‚Äôimage Docker
      - name: Build Docker image
        run: |
          IMAGE_NAME="${{ secrets.DOCKER_USERNAME }}/myapp"
          TAG="dev"
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            TAG="${GITHUB_REF#refs/tags/}"
          fi
          docker build -t $IMAGE_NAME:$TAG .

      # 5Ô∏è‚É£ Push de l‚Äôimage Docker
      - name: Push Docker image
        run: |
          IMAGE_NAME="${{ secrets.DOCKER_USERNAME }}/myapp"
          TAG="dev"
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            TAG="${GITHUB_REF#refs/tags/}"
          fi
          docker push $IMAGE_NAME:$TAG

      # 6Ô∏è‚É£ Notification Google Chat
      - name: Send Google Chat Notification
        if: always()
        run: |
          STATUS="${{ job.status }}"
          COMMIT_MSG=$(git log -1 --pretty=%B)
          AUTHOR=$(git log -1 --pretty=%an)
          MESSAGE="{
            'text': 'üöÄ *CI/CD Pipeline ex√©cut√©e*\n
            ‚Ä¢ *Statut*: $STATUS\n
            ‚Ä¢ *Auteur*: $AUTHOR\n
            ‚Ä¢ *Commit*: $COMMIT_MSG\n
            ‚Ä¢ *R√©f√©rence*: $GITHUB_REF'
          }"
          curl -X POST -H 'Content-Type: application/json' \
            -d "$MESSAGE" \
            ${{ secrets.GOOGLE_CHAT_WEBHOOK_URL }}
