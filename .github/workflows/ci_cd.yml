name: CI/CD Pipeline - Docker + Tests + Notifications

on:
  push:
    branches: [main]
  create:
    tags: ['v*']

jobs:
  build-test-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout du d√©p√¥t
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Ex√©cution des tests
      - name: Run tests
        run: |
          cd app
          chmod +x check_app.sh
          ./check_app.sh

      # 3Ô∏è‚É£ Connexion au registre Docker
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # 4Ô∏è‚É£ Construction de l‚Äôimage Docker
      - name: Build Docker image
        run: |
          IMAGE_NAME="${{ secrets.DOCKER_USERNAME }}/myapp"
          TAG="dev"
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            TAG="${GITHUB_REF#refs/tags/}"
          fi
          docker build -t $IMAGE_NAME:$TAG ./app

      # 5Ô∏è‚É£ Push de l‚Äôimage Docker
      - name: Push Docker image
        run: |
          IMAGE_NAME="${{ secrets.DOCKER_USERNAME }}/myapp"
          TAG="dev"
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            TAG="${GITHUB_REF#refs/tags/}"
          fi
          docker push $IMAGE_NAME:$TAG

      # 6Ô∏è‚É£ Notification Google Chat s√©curis√©ey
      - name: Send Google Chat Notification
        if: always()  # Toujours ex√©cut√© m√™me si le job √©choue
        run: |
          STATUS="${{ job.status }}"
          COMMIT_MSG=$(git log -1 --pretty=%B)
          AUTHOR=$(git log -1 --pretty=%an)
          MESSAGE="{
            'text': 'üöÄ *CI/CD Pipeline ex√©cut√©e*\n
            ‚Ä¢ *Statut*: $STATUS\n
            ‚Ä¢ *Auteur*: $AUTHOR\n
            ‚Ä¢ *Commit*: $COMMIT_MSG\n
            ‚Ä¢ *R√©f√©rence*: $GITHUB_REF'
          }"
          if [ -n "${{ secrets.GOOGLE_CHAT_WEBHOOK_URL }}" ]; then
            # Tente d'envoyer la notification, ignore l'erreur si le webhook est invalide
            curl -X POST -H 'Content-Type: application/json' \
              -d "$MESSAGE" \
              ${{ secrets.GOOGLE_CHAT_WEBHOOK_URL }} || echo "‚ö†Ô∏è Webhook invalide, notification non envoy√©e"
          else
            echo "‚ö†Ô∏è Secret GOOGLE_CHAT_WEBHOOK_URL manquant, notification ignor√©e"
          fi
